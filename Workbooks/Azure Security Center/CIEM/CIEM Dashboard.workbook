{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Permissions Management Dashboard\r\n\r\nThis workbook has been created to provide a single pane view for Permissions Management capability in Microsoft Defender for Cloud.Cloud Infrastructure Entitlement Management (CIEM) empowers security admins to identify overprovisioned, unused and super identities to facilitate the implementation and enforcement of least privilege access across multicloud environments.\r\n\r\n<svg viewBox=\"0 0 19 19\" width=\"20\" class=\"fxt-escapeShadow\" role=\"presentation\" focusable=\"false\" xmlns:svg=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" aria-hidden=\"true\"><g><path fill=\"#1b93eb\" d=\"M16.82 8.886c0 4.81-5.752 8.574-7.006 9.411a.477.477 0 01-.523 0C8.036 17.565 2.18 13.7 2.18 8.886V3.135a.451.451 0 01.42-.419C7.2 2.612 6.154.625 9.5.625s2.3 1.987 6.8 2.091a.479.479 0 01.523.419z\"></path><path fill=\"url(#0024423711759027356)\" d=\"M16.192 8.99c0 4.392-5.333 7.947-6.483 8.575a.319.319 0 01-.418 0c-1.15-.732-6.483-4.183-6.483-8.575V3.762a.575.575 0 01.313-.523C7.2 3.135 6.258 1.357 9.4 1.357s2.2 1.882 6.274 1.882a.45.45 0 01.419.418z\"></path><path d=\"M9.219 5.378a.313.313 0 01.562 0l.875 1.772a.314.314 0 00.236.172l1.957.284a.314.314 0 01.174.535l-1.416 1.38a.312.312 0 00-.09.278l.334 1.949a.313.313 0 01-.455.33l-1.75-.92a.314.314 0 00-.292 0l-1.75.92a.313.313 0 01-.455-.33L7.483 9.8a.312.312 0 00-.09-.278L5.977 8.141a.314.314 0 01.174-.535l1.957-.284a.314.314 0 00.236-.172z\" class=\"msportalfx-svg-c01\"></path></g></svg>&nbsp;<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-3px;left:-4px;\"> Please take the time to answer a quick survey. To submit your feedback,\r\n</span>[<span style=\"font-family: Open Sans; font-weight: 620; font-size: 14px;font-style: bold;margin:-10px 0px 0px 0px;position: relative;top:-3px;left:-4px;\"> click here. </span>](https://aka.ms/ciemintegrationmdc)"
      },
      "name": "Headline"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "4c5e04d8-fbe5-4c56-8002-93c420f52640",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "4c3cca0c-050c-46ae-8f51-a903faab9260",
            "version": "KqlParameterItem/1.0",
            "name": "Help",
            "label": "Show Help",
            "type": 10,
            "description": "Show insturctions for using this workbook",
            "isRequired": true,
            "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n { \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true }\\r\\n]\",\"transformers\":null}",
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 8
          },
          {
            "id": "f5091a43-6157-49c3-9aa9-b8286e8cc007",
            "version": "KqlParameterItem/1.0",
            "name": "filterUser",
            "type": 1,
            "isGlobal": true,
            "value": ""
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "#### Welcome to Permissions Management workbook\r\nThis workbook is based on the following recommendations provided by Microsoft Defender for Cloud:\r\n\r\nAzure/AWS/GCP overprovisioned identities should have only the necessary permissions\r\nSuper Identities in your Azure environment should be removed (Azure & GCP)\r\nUnused identities in your Azure environment should be removed (Azure, AWS & GCP)",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "Help",
        "comparison": "isEqualTo",
        "value": "Yes"
      },
      "name": "Help"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "d15cfabe-8b68-4e8d-b3b0-dd603ae11420",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Azure",
            "subTarget": "azure",
            "preText": "Azure",
            "style": "link",
            "tabWidth": "200px"
          },
          {
            "id": "459acc4b-152e-41cc-82eb-9059f1fb3e67",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "AWS",
            "subTarget": "aws",
            "style": "link",
            "tabWidth": "200px"
          },
          {
            "id": "38beb5d6-ec55-457c-8a11-5f6546b3b6c3",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "GCP",
            "subTarget": "gcp",
            "style": "link",
            "tabWidth": "200px"
          },
          {
            "id": "11a64eb8-af70-4ae9-b85c-5b8ab1523fe8",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "Attack Path",
            "subTarget": "attackpath",
            "style": "link",
            "tabWidth": "200px"
          }
        ]
      },
      "name": "tab"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Azure Overprovisioned Identities",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\" | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id) | where assessmentKey == \"d19d5a12-41e9-44e2-b7f5-ee2160f62d62\" | extend resourceId = tostring(properties.resourceDetails.Id) | extend xyzAssessmentCategory=tostring(properties.additionalData.ResourceType), status=tostring(properties.status.code) | where status == \"Unhealthy\" | summarize numOfResources=dcount(resourceId)  by xyzAssessmentCategory",
              "size": 4,
              "title": "Overprovisioned Identities",
              "exportFieldName": "xyzAssessmentCategory",
              "exportParameterName": "xyzAssessmentCategory",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "numOfResources"
                ],
                "group": "xyzAssessmentCategory",
                "createOtherGroup": 0,
                "showMetrics": false,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "User",
                    "color": "blue"
                  },
                  {
                    "seriesName": "ServicePrincipal",
                    "color": "green"
                  },
                  {
                    "seriesName": "Group",
                    "color": "orange"
                  }
                ]
              }
            },
            "customWidth": "25",
            "conditionalVisibility": {
              "parameterName": "filterUser",
              "comparison": "isEqualTo"
            },
            "name": "Overprovisioned Identities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)\r\n        | extend resourceId = tostring(properties.resourceDetails.Id)\r\n        | extend identityId = extract(@\"(?i)pricings/CloudPosture/securityentitydata/([^/]*)\", 1, id)\r\n        | extend status=tostring(properties.status.code),\r\n            permissionsCreepIndex=tolong(properties.additionalData.PermissionsCreepIndexScore),\r\n            resourceType = tostring(properties.additionalData.ResourceType)\r\n        | where assessmentKey == \"d19d5a12-41e9-44e2-b7f5-ee2160f62d62\"\r\n        | where status == \"Unhealthy\"\r\n        | extend identityId = iff(isnotempty('{filterUser}'), '{filterUser}', identityId)\r\n        | distinct identityId, resourceType, permissionsCreepIndex",
              "size": 0,
              "title": "List of Overprovisioned identities",
              "showRefreshButton": true,
              "exportedParameters": [
                {
                  "fieldName": "subAssessmentId",
                  "parameterName": "selecteduser",
                  "parameterType": 1
                },
                {
                  "fieldName": "assessmentKey",
                  "parameterName": "assessmentKey",
                  "parameterType": 1
                }
              ],
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "subAssessmentId",
                    "formatter": 1
                  }
                ],
                "rowLimit": 10000,
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "identityId",
                    "label": "Identity"
                  },
                  {
                    "columnId": "resourceType",
                    "label": "Category"
                  },
                  {
                    "columnId": "permissionsCreepIndex",
                    "label": "permissionsCreepIndex (PCI)"
                  }
                ]
              }
            },
            "customWidth": "70",
            "conditionalVisibilities": [
              {
                "parameterName": "tab",
                "comparison": "isEqualTo",
                "value": "azure"
              },
              {
                "parameterName": "filterUser",
                "comparison": "isEqualTo",
                "value": ""
              }
            ],
            "name": "azureoverprovisioned identities"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC"
              ],
              "parameters": [
                {
                  "id": "2c8d0d9d-2d1e-4aad-bd7f-cdb96dc3861d",
                  "version": "KqlParameterItem/1.0",
                  "name": "selectedUser",
                  "type": 1,
                  "isGlobal": true,
                  "query": "print '{selecteduser}'",
                  "crossComponentResources": [
                    "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC"
                  ],
                  "isHiddenWhenLocked": true,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "20",
            "name": "parameters - 13"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "id": "c2f7557c-598f-41b9-a05a-8271ed50cb16",
                  "linkTarget": "OpenBlade",
                  "linkLabel": "Defender for Cloud Recommendation",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "bladeOpenContext": {
                    "bladeName": "GenericResourceSubAssessmentsBlade",
                    "extensionName": "Microsoft_Azure_Security",
                    "bladeJsonParameters": "{\r\n    \"resourceId\": \"{resourceId}\",\r\n    \"assessmentKey\": \"{assessmentKey}\",\r\n    \"resourceName\": \"d1d8779d-38d7-4f06-91db-9cbc8de0176f\"\r\n}"
                  }
                },
                {
                  "id": "70dad37d-471d-414c-8f3c-77d867368efa",
                  "cellValue": "text",
                  "linkTarget": "WorkbookTemplate",
                  "linkLabel": "View User Details",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "workbookContext": {
                    "componentIdSource": "workbook",
                    "resourceIdsSource": "workbook",
                    "templateIdSource": "static",
                    "templateId": "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/ciemintegration/providers/microsoft.insights/workbooks/f8ea2eab-5c00-40c0-a05e-4e04fc23305f",
                    "typeSource": "workbook",
                    "gallerySource": "workbook",
                    "locationSource": "workbook",
                    "workbookName": "Azure Used/Unused Permissions of Identity",
                    "passSpecificParams": true,
                    "templateParameters": [
                      {
                        "name": "Subscription",
                        "source": "parameter",
                        "value": "Subscription"
                      },
                      {
                        "name": "filterUser",
                        "source": "parameter",
                        "value": "selectedUser"
                      }
                    ],
                    "viewerMode": true
                  }
                }
              ]
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "filterUser",
              "comparison": "isEqualTo"
            },
            "name": "links - 14"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## {filterUser}\r\n-----------------------------------------\r\n"
                  },
                  "name": "text - 0"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "securityresources | where type =~ \"microsoft.security/assessments/subassessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id), subAssessmentId=tostring(properties.id), parentResourceId= extract(\"(.+)/providers/Microsoft.Security\", 1, id)\r\n        | where subAssessmentId == '{filterUser}'\r\n        | extend resourceId = tostring(properties.resourceDetails.id)\r\n        | extend subAssessmentName=tostring(properties.displayName),\r\n            subAssessmentDescription=tostring(properties.description),\r\n            subAssessmentRemediation=tostring(properties.remediation),\r\n            subAssessmentCategory=tostring(properties.category),\r\n            subAssessmentImpact=tostring(properties.impact),\r\n            severity=tostring(properties.status.severity),\r\n            status=tostring(properties.status.code),\r\n            cause=tostring(properties.status.cause),\r\n            statusDescription=tostring(properties.status.description),\r\n            permissionsCreepIndex=tolong(properties.additionalData.permissionsCreepIndex.score),\r\n            additionalData=tostring(properties.additionalData)\r\n        | where assessmentKey == \"dcedec72-5b25-45b3-b8b9-0ed9219f8f29\"\r\n                      | where status == \"Unhealthy\"\r\n      //| extend score == todynamic(todynamic(permissionsCreepIndex).permissionsCreepIndex).score\r\n        | summarize numOfResources=dcount(resourceId), timeGenerated=arg_max(todatetime(properties.timeGenerated), additionalData), permissionsCreepIndex=max(permissionsCreepIndex) by assessmentKey, subAssessmentId, subAssessmentName, subAssessmentCategory, severity, status, cause, statusDescription, subAssessmentDescription, subAssessmentRemediation, subAssessmentImpact\r\n        | extend high = iff(severity == \"High\", 3,0), medium = iff(severity == \"Medium\", 2, 0), low = iff(severity == \"Low\", 1 ,0)\r\n        | extend all = high + medium + low\r\n        | order by all desc, numOfResources desc\r\n       // | top 100 by all\r\n       ",
                    "size": 4,
                    "title": "Selected overprovisioned identity",
                    "exportFieldName": "subAssessmentId",
                    "exportParameterName": "IdentityExport",
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "assessmentKey",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "subAssessmentName",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "status",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "cause",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "statusDescription",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "subAssessmentDescription",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "subAssessmentRemediation",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "subAssessmentImpact",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "numOfResources",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "timeGenerated",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "additionalData",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "high",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "medium",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "low",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "all",
                          "formatter": 5
                        }
                      ],
                      "rowLimit": 500,
                      "labelSettings": [
                        {
                          "columnId": "subAssessmentId",
                          "label": "Identity"
                        }
                      ]
                    }
                  },
                  "conditionalVisibility": {
                    "parameterName": "tab",
                    "comparison": "isEqualTo",
                    "value": "azure"
                  },
                  "name": "azureoverprovisioned identities - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "securityresources \r\n| where type =~ \"microsoft.security/assessments/subassessments\" \r\n| extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id), subAssessmentId=tostring(properties.id), parentResourceId= extract(\"(.+)/providers/Microsoft.Security\", 1, id) \r\n| extend resourceId = tostring(properties.resourceDetails.id) \r\n| where subAssessmentId == \"{filterUser}\" \r\n| extend usedPermissions = properties.additionalData.used\r\n| extend unusedPermissions = properties.additionalData.unused\r\n| project usedPermissions, unusedPermissions\r\n| mv-expand usedPermissions, unusedPermissions\r\n| project usedPermissions = usedPermissions.externalId, unusedPermissions = unusedPermissions.externalId\r\n//| extend unusedPermissions = tostring(properties.additionalData.unused) \r\n//| extend usedPermissions = tostring(properties.additionalData.used) ",
                    "size": 2,
                    "title": "Unused&UsedPermissions",
                    "showExportToExcel": true,
                    "queryType": 1,
                    "resourceType": "microsoft.resourcegraph/resources",
                    "crossComponentResources": [
                      "{Subscription}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "usedPermissions",
                          "formatter": 1,
                          "formatOptions": {
                            "workbookContext": {
                              "componentIdSource": "workbook",
                              "resourceIdsSource": "workbook",
                              "templateIdSource": "cell",
                              "typeSource": "workbook",
                              "gallerySource": "workbook",
                              "locationSource": "workbook",
                              "workbookName": "usedunusedpermissions",
                              "viewerMode": false
                            }
                          }
                        },
                        {
                          "columnMatch": "Base",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "usedPermissions",
                          "label": "UsedPermissions"
                        },
                        {
                          "columnId": "unusedPermissions",
                          "label": "UnusedPermissions"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "name": "Unused&UsedPermissions"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "filterUser",
              "comparison": "isNotEqualTo"
            },
            "name": "userDetails"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "azure"
      },
      "customWidth": "100",
      "name": "Azure Overprovisioned Identities",
      "styleSettings": {
        "margin": "10",
        "padding": "10",
        "maxWidth": "100%"
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Azure Unused Identities",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)\r\n        | extend resourceId = tostring(properties.resourceDetails.Id)\r\n        | where assessmentKey == \"8b0bd683-bcfe-4ab1-96b9-f15a60eaa89d\"\r\n        | extend status=tostring(properties.status.code), resourceType = tostring(properties.additionalData.ResourceType)\r\n        | where status == \"Unhealthy\"\r\n        | summarize numOfResources=dcount(resourceId) by assessmentKey, resourceType",
              "size": 4,
              "title": "Unused Identities Summary",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "numOfResources"
                ],
                "group": "resourceType",
                "createOtherGroup": 0,
                "showMetrics": false,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "User",
                    "color": "blue"
                  },
                  {
                    "seriesName": "ServicePrincipal",
                    "color": "green"
                  },
                  {
                    "seriesName": "Group",
                    "color": "orange"
                  }
                ]
              }
            },
            "customWidth": "28",
            "name": "Azure Unused Identities",
            "styleSettings": {
              "margin": "0",
              "padding": "0"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)        \r\n        | extend resourceId = tostring(properties.resourceDetails.Id)\r\n        | where assessmentKey == \"8b0bd683-bcfe-4ab1-96b9-f15a60eaa89d\"\r\n        | extend \r\n            status=tostring(properties.status.code),\r\n            additionalData=tostring(properties.additionalData)\r\n        | where status == \"Unhealthy\"\r\n        | extend identity = strcat(extract(@\"(?i)pricings/CloudPosture/securityentitydata/([^/]*)\", 1, id), iff(isnotempty(properties.resourceDetails.ResourceName), strcat(\" (\", properties.resourceDetails.ResourceName, \")\"), \"\"))\r\n        | distinct identity",
              "size": 0,
              "title": "List of unused identities",
              "noDataMessage": "select an affected unused identity",
              "exportFieldName": "identity",
              "exportParameterName": "selecteduser",
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "identity",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "100%"
                    }
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "identity",
                    "label": "Affected Identity"
                  }
                ]
              }
            },
            "customWidth": "28",
            "name": "List of unused identities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)\r\n        | extend identity = strcat(extract(@\"(?i)pricings/CloudPosture/securityentitydata/([^/]*)\", 1, id), iff(isnotempty(properties.resourceDetails.ResourceName), strcat(\" (\", properties.resourceDetails.ResourceName, \")\"), \"\"))\r\n        | where identity == \"{selecteduser}\"\r\n        | extend \r\n            severity=tostring(properties.metadata.severity),\r\n            status=tostring(properties.status.code),\r\n            permissionsCreepIndex=tolong(properties.additionalData.PermissionsCreepIndexScore),\r\n            resourceType = tostring(properties.additionalData.ResourceType)\r\n        | where assessmentKey == \"8b0bd683-bcfe-4ab1-96b9-f15a60eaa89d\"\r\n        | where status == \"Unhealthy\"\r\n        | project identity,resourceType, permissionsCreepIndex, severity ",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "labelSettings": [
                  {
                    "columnId": "identity",
                    "label": "Identity"
                  },
                  {
                    "columnId": "resourceType",
                    "label": "Category"
                  },
                  {
                    "columnId": "permissionsCreepIndex",
                    "label": "PCI"
                  },
                  {
                    "columnId": "severity",
                    "label": "Severity"
                  }
                ]
              }
            },
            "customWidth": "33",
            "name": "query - 2"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "tab",
          "comparison": "isEqualTo",
          "value": "azure"
        },
        {
          "parameterName": "filterUser",
          "comparison": "isEqualTo"
        }
      ],
      "name": "Azure Unused Identities"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Azure Super Identities",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)\r\n        | extend resourceId = tostring(properties.resourceDetails.id)\r\n        | extend status=tostring(properties.status.code), resourceType = tostring(properties.additionalData.ResourceType)\r\n        | where assessmentKey == \"e4ba0808-01c2-43c0-a110-03381cc8f3ee\"\r\n        | where status == \"Unhealthy\"\r\n        | summarize numOfResources=dcount(resourceId) by resourceType",
              "size": 4,
              "title": "Super Identities Summary",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "numOfResources"
                ],
                "group": "resourceType",
                "createOtherGroup": 0,
                "showMetrics": false,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "User",
                    "color": "blue"
                  },
                  {
                    "seriesName": "ServicePrincipal",
                    "color": "green"
                  },
                  {
                    "seriesName": "Group",
                    "color": "orange"
                  }
                ]
              }
            },
            "customWidth": "30",
            "name": "Super Identities Summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)\r\n        | extend resourceId = tostring(properties.resourceDetails.Id)\r\n        | extend severity=tostring(properties.metadata.severity), status=tostring(properties.status.code)\r\n        | where assessmentKey == \"e4ba0808-01c2-43c0-a110-03381cc8f3ee\"\r\n        | where status == \"Unhealthy\"\r\n        | extend identity = strcat(extract(@\"(?i)pricings/CloudPosture/securityentitydata/([^/]*)\", 1, resourceId), iff(isnotempty(properties.resourceDetails.ResourceName), strcat(\" (\", properties.resourceDetails.ResourceName, \")\"), \"\"))\r\n        | extend high = iff(severity == \"High\", 3,0), medium = iff(severity == \"Medium\", 2, 0), low = iff(severity == \"Low\", 1 ,0)\r\n        | extend all = high + medium + low\r\n        | order by all desc     \r\n        | top 100 by all\r\n        | distinct identity\r\n",
              "size": 0,
              "title": "List of SuperIdentities",
              "exportFieldName": "identity",
              "exportParameterName": "selecteduser",
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "identity",
                    "label": "Affected Identity"
                  }
                ]
              }
            },
            "customWidth": "28",
            "name": "List of SuperIdentities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources | where type =~ \"microsoft.security/assessments\"\r\n        | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id)\r\n        | extend resourceId = tostring(properties.resourceDetails.Id)\r\n        | extend identity = strcat(extract(@\"(?i)pricings/CloudPosture/securityentitydata/([^/]*)\", 1, resourceId), iff(isnotempty(properties.resourceDetails.ResourceName), strcat(\" (\", properties.resourceDetails.ResourceName, \")\"), \"\"))\r\n        | where identity == \"{selecteduser}\"\r\n        | extend severity=tostring(properties.metadata.severity),\r\n            status=tostring(properties.status.code),\r\n            permissionsCreepIndex=tolong(properties.additionalData.PermissionsCreepIndexScore),\r\n            type = tostring(properties.additionalData.ResourceType)\r\n        | where assessmentKey == \"e4ba0808-01c2-43c0-a110-03381cc8f3ee\"\r\n        | where status == \"Unhealthy\"\r\n        | project identity,type, permissionsCreepIndex, severity",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "labelSettings": [
                  {
                    "columnId": "identity",
                    "label": "Identity"
                  },
                  {
                    "columnId": "type",
                    "label": "Category"
                  },
                  {
                    "columnId": "permissionsCreepIndex",
                    "label": "PCI"
                  },
                  {
                    "columnId": "severity",
                    "label": "Severity"
                  }
                ]
              }
            },
            "customWidth": "33",
            "name": "query - 2"
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "tab",
          "comparison": "isEqualTo",
          "value": "azure"
        },
        {
          "parameterName": "filterUser",
          "comparison": "isEqualTo"
        }
      ],
      "name": "Azure Super Identities"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "AWS",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources \r\n    | where type =~ \"microsoft.security/assessments\" \r\n    | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id) \r\n    | where assessmentKey == \"427f7886-bb3c-42f6-a22c-979780b8e5ef\" \r\n    | extend resourceId = tostring(properties.resourceDetails.Id) \r\n    | extend xyzAssessmentCategory=tostring(properties.additionalData.ResourceType), status=tostring(properties.status.code) \r\n    | where status == \"Unhealthy\" \r\n    | summarize numOfResources=dcount(resourceId)  by xyzAssessmentCategory",
              "size": 4,
              "title": "OverProvisioned Identities ",
              "exportFieldName": "series",
              "exportParameterName": "identity",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "numOfResources"
                ],
                "group": "xyzAssessmentCategory",
                "createOtherGroup": 0,
                "showMetrics": false,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "Role",
                    "label": "AWS IAM Role",
                    "color": "blue"
                  }
                ]
              }
            },
            "customWidth": "33",
            "name": "OverProvisioned Identities "
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources \r\n    | where type =~ \"microsoft.security/assessments\" \r\n    | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id) \r\n    | where assessmentKey == \"427f7886-bb3c-42f6-a22c-979780b8e5ef\" \r\n    | extend resourceId = tostring(properties.resourceDetails.Id), Identity = tostring(properties.additionalData.NativeCloudUniqueIdentifier), pci = tolong(properties.additionalData.PermissionsCreepIndexScore)\r\n    | extend category=tostring(properties.additionalData.ResourceType), status=tostring(properties.status.code), severity = tostring(properties.metadata.severity)\r\n    | where status == \"Unhealthy\" \r\n    | extend high = iff(severity == \"High\", 3,0), medium = iff(severity == \"Medium\", 2, 0), low = iff(severity == \"Low\", 1 ,0)\r\n    | extend all = high+medium+low\r\n    | order by all\r\n    | take 100 \r\n    | project Identity, category, pci, severity",
              "size": 0,
              "exportFieldName": "Identity",
              "exportParameterName": "nativeResourceId",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "labelSettings": [
                  {
                    "columnId": "Identity",
                    "label": "Identity"
                  },
                  {
                    "columnId": "category",
                    "label": "Category"
                  },
                  {
                    "columnId": "pci",
                    "label": "PCI"
                  },
                  {
                    "columnId": "severity",
                    "label": "Severity"
                  }
                ]
              },
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources \r\n    | where type =~ \"microsoft.security/assessments\" \r\n    | extend assessmentKey=extract(@\"(?i)providers/Microsoft.Security/assessments/([^/]*)\", 1, id) \r\n    | where assessmentKey == \"427f7886-bb3c-42f6-a22c-979780b8e5ef\" \r\n    | extend resourceId = tostring(properties.resourceDetails.Id), Identity = tostring(properties.additionalData.NativeCloudUniqueIdentifier), pci = tolong(properties.additionalData.PermissionsCreepIndexScore)\r\n    | extend category=tostring(properties.additionalData.ResourceType), status=tostring(properties.status.code), severity = tostring(properties.metadata.severity)\r\n    | where status == \"Unhealthy\" \r\n    | where Identity == '{nativeResourceId}'\r\n    | project Used = parse_json(tostring(properties.additionalData.used)), Unused = parse_json(tostring(properties.additionalData.unused))\r\n    | mv-expand Unused, Used\r\n    | project Used = Used.externalId, Unused = Unused.externalId",
              "size": 0,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "assessmentKey",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "cause",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "additionalData",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkIsContextBlade": true
                    }
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "type",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "tenantId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "kind",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "location",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "managedBy",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "sku",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "plan",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "tags",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "identity",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "zones",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "extendedLocation",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "resourceId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "resourcetype",
                    "formatter": 5
                  }
                ],
                "rowLimit": 5000,
                "filter": true
              }
            },
            "customWidth": "80",
            "conditionalVisibility": {
              "parameterName": "X",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "Unused-usedActions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"a3ab53ab-7905-46a5-b6be-11f21cccb07a\",\"mergeType\":\"table\",\"leftTable\":\"Unused-usedActions\"}],\"projectRename\":[{\"originalName\":\"[Unused-usedActions].Unused\",\"mergedName\":\"Unused Action\",\"fromId\":\"a3ab53ab-7905-46a5-b6be-11f21cccb07a\"},{\"originalName\":\"[Unused-usedActions].Used\"}]}",
              "size": 0,
              "queryType": 7
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "nativeResourceId",
              "comparison": "isNotEqualTo"
            },
            "showPin": false,
            "name": "query - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"a3ab53ab-7905-46a5-b6be-11f21cccb074\",\"mergeType\":\"table\",\"leftTable\":\"Unused-usedActions\"}],\"projectRename\":[{\"originalName\":\"[Unused-usedActions].Used\",\"mergedName\":\"Used Action\",\"fromId\":\"a3ab53ab-7905-46a5-b6be-11f21cccb074\"},{\"originalName\":\"[Unused-usedActions].Unused\"}]}",
              "size": 0,
              "queryType": 7
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "nativeResourceId",
              "comparison": "isNotEqualTo"
            },
            "showPin": false,
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources\r\n        | where type == \"microsoft.security/assessments\"\r\n        | extend source = trim(' ', tolower(tostring(properties.resourceDetails.Source)))\r\n                                          | extend resourceId = trim(' ', tolower(tostring(case(\r\n                                                                                    source =~ \"azure\", properties.resourceDetails.Id,\r\n                                                                                    source =~ \"aws\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ \"gcp\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ 'aws', properties.resourceDetails.AzureResourceId,\r\n                                                                                    source =~ 'gcp', properties.resourceDetails.AzureResourceId,\r\n                                                                                    extract('^(.+)/providers/Microsoft.Security/assessments/.+$',1,id)\r\n                                                                                    ))))\r\n        | extend status = trim(\" \", tostring(properties.status.code))\r\n        | extend cause = trim(\" \", tostring(properties.status.cause))\r\n        | extend resourcetype = trim(\" \", tostring(properties.additionalData.ResourceType))\r\n        | extend assessmentKey = tostring(name)\r\n        | where assessmentKey == \"71016e8c-d079-479d-942b-9c95b463e4a6\"\r\n      | summarize count() by resourcetype",
              "size": 4,
              "title": "Unused Identities",
              "exportFieldName": "series",
              "exportParameterName": "identity1",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart"
            },
            "customWidth": "30",
            "name": "Unused Identities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources\r\n        | where type == \"microsoft.security/assessments\"\r\n        | extend source = trim(' ', tolower(tostring(properties.resourceDetails.Source)))\r\n                                          | extend resourceId = trim(' ', tolower(tostring(case(\r\n                                                                                    source =~ \"azure\", properties.resourceDetails.Id,\r\n                                                                                    source =~ \"aws\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ \"gcp\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ 'aws', properties.resourceDetails.AzureResourceId,\r\n                                                                                    source =~ 'gcp', properties.resourceDetails.AzureResourceId,\r\n                                                                                    extract('^(.+)/providers/Microsoft.Security/assessments/.+$',1,id)\r\n                                                                                    ))))\r\n        | extend status = trim(\" \", tostring(properties.status.code))\r\n        | extend cause = trim(\" \", tostring(properties.status.cause))\r\n        | extend resourcetype = trim(\" \", tostring(properties.additionalData.ResourceType))\r\n        | extend assessmentKey = tostring(name)\r\n        | where assessmentKey == \"71016e8c-d079-479d-942b-9c95b463e4a6\"\r\n        | project resourceId, resourcetype\r\n\r\n",
              "size": 0,
              "exportFieldName": "id",
              "exportParameterName": "identity1",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - 4"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "aws"
      },
      "customWidth": "80",
      "name": "AWS",
      "styleSettings": {
        "margin": "10",
        "padding": "10",
        "maxWidth": "100%",
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "GCP",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources\r\n        | where type == \"microsoft.security/assessments\"\r\n        | extend source = trim(' ', tolower(tostring(properties.resourceDetails.Source)))\r\n                                          | extend resourceId = trim(' ', tolower(tostring(case(\r\n                                                                                    source =~ \"azure\", properties.resourceDetails.Id,\r\n                                                                                    source =~ \"aws\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ \"gcp\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ 'aws', properties.resourceDetails.AzureResourceId,\r\n                                                                                    source =~ 'gcp', properties.resourceDetails.AzureResourceId,\r\n                                                                                    extract('^(.+)/providers/Microsoft.Security/assessments/.+$',1,id)\r\n                                                                                    ))))\r\n        | extend status = trim(\" \", tostring(properties.status.code))\r\n        | extend cause = trim(\" \", tostring(properties.status.cause))\r\n        | extend resourcetype = trim(\" \", tostring(properties.additionalData.ResourceType))\r\n        | extend assessmentKey = tostring(name)\r\n        | where assessmentKey == \"8353c257-30be-4048-8ac3-b8f26d89d2ea\"\r\n      | summarize count() by resourcetype",
              "size": 4,
              "title": "overprovisioned identities",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "piechart",
              "chartSettings": {
                "yAxis": [
                  "count_"
                ],
                "group": "resourcetype",
                "createOtherGroup": 0,
                "showMetrics": false,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "User",
                    "color": "blue"
                  },
                  {
                    "seriesName": "ServiceAccount",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "30",
            "name": "overprovisioned identities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources\r\n        | where type == \"microsoft.security/assessments\"\r\n        | extend source = trim(' ', tolower(tostring(properties.resourceDetails.Source)))\r\n                                          | extend resourceId = trim(' ', tolower(tostring(case(\r\n                                                                                    source =~ \"azure\", properties.resourceDetails.Id,\r\n                                                                                    source =~ \"aws\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ \"gcp\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ 'aws', properties.resourceDetails.AzureResourceId,\r\n                                                                                    source =~ 'gcp', properties.resourceDetails.AzureResourceId,\r\n                                                                                    extract('^(.+)/providers/Microsoft.Security/assessments/.+$',1,id)\r\n                                                                                    ))))\r\n        | extend status = trim(\" \", tostring(properties.status.code))\r\n        | extend cause = trim(\" \", tostring(properties.status.cause))\r\n        | extend resourcetype = trim(\" \", tostring(properties.additionalData.ResourceType))\r\n        | extend assessmentKey = tostring(name)\r\n        | where assessmentKey == \"257e9506-fd47-4123-a8ef-92017f845906\"\r\n      | summarize count() by resourcetype",
              "size": 4,
              "title": "Unused Identities",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart"
            },
            "customWidth": "30",
            "name": "Unused Identities",
            "styleSettings": {
              "maxWidth": "100%"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "securityresources\r\n        | where type == \"microsoft.security/assessments\"\r\n        | extend source = trim(' ', tolower(tostring(properties.resourceDetails.Source)))\r\n                                          | extend resourceId = trim(' ', tolower(tostring(case(\r\n                                                                                    source =~ \"azure\", properties.resourceDetails.Id,\r\n                                                                                    source =~ \"aws\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ \"gcp\" and isnotempty(tostring(properties.resourceDetails.ConnectorId)), properties.resourceDetails.Id,\r\n                                                                                    source =~ 'aws', properties.resourceDetails.AzureResourceId,\r\n                                                                                    source =~ 'gcp', properties.resourceDetails.AzureResourceId,\r\n                                                                                    extract('^(.+)/providers/Microsoft.Security/assessments/.+$',1,id)\r\n                                                                                    ))))\r\n        | extend status = trim(\" \", tostring(properties.status.code))\r\n        | extend cause = trim(\" \", tostring(properties.status.cause))\r\n        | extend resourcetype = trim(\" \", tostring(properties.additionalData.ResourceType))\r\n        | extend assessmentKey = tostring(name)\r\n        | where assessmentKey == \"7057d0ba-7d1c-4484-8bae-e82785cf8418\"\r\n      | summarize count() by resourcetype",
              "size": 4,
              "title": "Super Identities",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "value::all"
              ],
              "visualization": "piechart"
            },
            "customWidth": "30",
            "name": "Super Identities"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "gcp"
      },
      "customWidth": "80",
      "name": "GCP",
      "styleSettings": {
        "margin": "10",
        "padding": "10",
        "maxWidth": "100%",
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type == \"microsoft.security/attackpaths\"\r\n| extend attackPathSteps = tolower(properties.attackPathSteps)\r\n| where attackPathSteps has \"has permissions to\"\r\n| extend graphComponent = properties.graphComponent\r\n| mv-expand connection = graphComponent.connections\r\n| extend connectionTitle = tostring(connection[\"title\"])\r\n| where connectionTitle == \"has permissions to\" // consider using set of definition keys\r\n| extend sourceEntityInternalId = tostring(connection[\"sourceEntityInternalId\"])\r\n| mv-expand entity = graphComponent.entities\r\n| extend entityInternalId = tostring(entity[\"entityInternalId\"])\r\n| where sourceEntityInternalId == entityInternalId\r\n| extend entityType = tostring(entity.entityType)\r\n| summarize apCount = count()\r\n| project lable = \"Attack Path\", apCount",
        "size": 1,
        "title": "Total Number of Attack Paths",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "tiles",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "lable",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "apCount",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          },
          "showBorder": true,
          "size": "auto"
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "attackpath"
      },
      "customWidth": "15",
      "name": "Attack Path",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type == \"microsoft.security/attackpaths\"\r\n| mv-expand riskCategories = properties.riskCategories\r\n| project apId = name, apTemplate = tostring(properties.displayName), tostring(riskCategories)\r\n| summarize dcount(apId) by riskCategories",
        "size": 0,
        "title": "Risk Found (by Categories)",
        "showRefreshButton": true,
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "visualization": "piechart"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "attackpath"
      },
      "customWidth": "50",
      "name": "Risk Found (by Categories)"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type == \"microsoft.security/attackpaths\"\r\n| extend attackPathSteps = tolower(properties.attackPathSteps)\r\n| where attackPathSteps has \"has permissions to\"\r\n| extend graphComponent = properties.graphComponent\r\n| mv-expand connection = graphComponent.connections\r\n| extend connectionTitle = tostring(connection[\"title\"])\r\n| where connectionTitle == \"has permissions to\" // consider using set of definition keys\r\n| extend sourceEntityInternalId = tostring(connection[\"sourceEntityInternalId\"])\r\n| mv-expand entity = graphComponent.entities\r\n| extend entityInternalId = tostring(entity[\"entityInternalId\"])\r\n| where sourceEntityInternalId == entityInternalId\r\n| extend entityType = tostring(entity.entityType)\r\n| extend attackpath= tostring(properties.displayName), attackPathType = properties.attackPathType, attackPathId = properties.attackPathId\r\n| project attackpath, connectionTitle, subscriptionId, type, attackPathType, attackPathId\r\n//| extend name = tostring(properties.connections.additionalData.roles,name)\r\n//| project connectionTitle, graphComponent, subscription, entityType, type, name\r\n//| project displayName\r\n//| summarize apCount = count()\r\n//| project lable = \"Attack Path\", apCount",
        "size": 0,
        "exportedParameters": [
          {
            "fieldName": "attackpath",
            "parameterName": "attackpath",
            "parameterType": 1
          },
          {
            "fieldName": "attackPathId",
            "parameterName": "attackPathId",
            "parameterType": 1
          },
          {
            "fieldName": "attackPathType",
            "parameterName": "attackPathType",
            "parameterType": 1
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "value::all"
        ],
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "id",
              "formatter": 5
            },
            {
              "columnMatch": "name",
              "formatter": 5
            },
            {
              "columnMatch": "tenantId",
              "formatter": 5
            },
            {
              "columnMatch": "kind",
              "formatter": 5
            },
            {
              "columnMatch": "location",
              "formatter": 5
            },
            {
              "columnMatch": "resourceGroup",
              "formatter": 5
            },
            {
              "columnMatch": "subscriptionId",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "managedBy",
              "formatter": 5
            },
            {
              "columnMatch": "sku",
              "formatter": 5
            },
            {
              "columnMatch": "plan",
              "formatter": 5
            },
            {
              "columnMatch": "properties",
              "formatter": 5
            },
            {
              "columnMatch": "tags",
              "formatter": 5
            },
            {
              "columnMatch": "identity",
              "formatter": 5
            },
            {
              "columnMatch": "zones",
              "formatter": 5
            },
            {
              "columnMatch": "extendedLocation",
              "formatter": 5
            }
          ]
        },
        "sortBy": []
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "attackpath"
      },
      "name": "query - 12"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "paragraph",
        "links": [
          {
            "id": "d9808572-0c8d-411f-9560-55df422b6036",
            "linkTarget": "OpenBlade",
            "linkLabel": "Open Attack Path Details",
            "style": "primary",
            "bladeOpenContext": {
              "bladeName": "AttackPathType.ReactView",
              "extensionName": "Microsoft_Azure_Security",
              "bladeJsonParameters": "{\r\n    \"attackPathType\": \"{attackPathType}\",\r\n    \"attackPathTypeName\": \"{attackpath}\",\r\n    \"attackPathId\": \"{attackPathId}\"\r\n}"
            }
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "attackpath"
      },
      "name": "links - 13"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "bullets",
        "links": [
          {
            "id": "25495229-8856-4a5a-9ad0-0da8d5dbec57",
            "cellValue": "text",
            "linkTarget": "WorkbookTemplate",
            "linkLabel": "View User Details ",
            "postText": "",
            "style": "primary",
            "linkIsContextBlade": true,
            "workbookContext": {
              "componentIdSource": "workbook",
              "resourceIdsSource": "workbook",
              "templateIdSource": "static",
              "templateId": "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/ciemintegration/providers/microsoft.insights/workbooks/f8ea2eab-5c00-40c0-a05e-4e04fc23305f",
              "typeSource": "workbook",
              "gallerySource": "workbook",
              "locationSource": "workbook",
              "workbookName": "AWS Overprovisioned Identities Used/Unused Permissions",
              "passSpecificParams": true,
              "templateParameters": [
                {
                  "name": "Subscription",
                  "source": "parameter",
                  "value": "Subscription"
                },
                {
                  "name": "filterUser",
                  "source": "parameter",
                  "value": "filterUser"
                }
              ],
              "viewerMode": false
            }
          },
          {
            "id": "bb29f4b1-217e-418b-9f79-7b780589db0a",
            "linkTarget": "OpenBlade",
            "linkLabel": "Defender for Cloud Recommendation",
            "style": "link",
            "bladeOpenContext": {
              "bladeName": "GenericResourceSubAssessmentsBlade",
              "extensionName": "Microsoft_Azure_Security",
              "bladeJsonParameters": "{\r\n    \"resourceId\": \"{resourceId}\",\r\n    \"assessmentKey\": \"{assessmentKey}\",\r\n    \"resourceName\": \"d1d8779d-38d7-4f06-91db-9cbc8de0176f\"\r\n}"
            }
          }
        ]
      },
      "name": "links - 13"
    }
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}